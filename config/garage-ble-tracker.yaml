esphome:
  name: garage-ble-tracker
  friendly_name: Garage BLE Tracker

esp32:
  board: esp32-c3-devkitm-1
  variant: ESP32C3
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_BT_BLE_42_FEATURES_SUPPORTED: y
      CONFIG_BT_BLE_50_FEATURES_SUPPORTED: y
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "10"

logger:
  level: DEBUG
  baud_rate: 0 # disables serial logging

api:
  encryption:
    key: !secret garage_ble_tracker_api
  on_client_connected:
     - esp32_ble_tracker.start_scan:
        continuous: true
  # Disable BLE tracking when there are no api connections live
  on_client_disconnected:
    if:
      condition:
        not:
          api.connected:
      then:
        - esp32_ble_tracker.stop_scan:

ota:
  - platform: esphome
    password: !secret garage_ble_tracker_ota

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2
  ap:
    ssid: "Garage-BLE-Tracker"
    password: !secret fallback_password

captive_portal:

time:
  - platform: homeassistant
    id: homeassistant_time

button:
  - platform: restart
    name: "Restart"
    entity_category: config

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
      entity_category: diagnostic
    ssid:
      name: "SSID"
      entity_category: diagnostic
    bssid:
      name: "BSSID"
      entity_category: diagnostic
    mac_address: 
      name: "MAC Address"
      entity_category: diagnostic

esp32_ble_tracker:
  scan_parameters:
    continuous: false # Don't auto start BLE scanning, we control it in the `api` block's automation.
    active: true  # send scan-request packets to gather more info, like device name for some devices.
    interval: 320ms  # default 320ms - how long to spend on each advert channel
    window:   300ms  # default 30ms - how long to actually "listen" in each interval. Reduce this if device is unstable.
    # If the device cannot keep up or becomes unstable, reduce the "window" setting. This may be
    # required if your device is controlling other sensors or doing PWM for lights etc.

bluetooth_proxy:
  active: true

binary_sensor:
  - platform: ble_presence
    mac_address: !secret mac_trash
    icon: mdi:trash-can
    name: "Trash Can"

  - platform: ble_presence
    mac_address: !secret mac_recycle
    icon: mdi:recycle
    name: "Recycle Bin"

sensor:
  # median value over 60 seconds, transmit every 60 seconds
  - platform: ble_rssi
    mac_address: !secret mac_trash
    name: "Trash Can RSSI Value"
    filters: 
      - median:
          window_size: 60
          send_every: 60
  - platform: ble_rssi
    mac_address: !secret mac_recycle
    name: "Recycle Bin RSSI Value"
    filters: 
      - median:
          window_size: 60
          send_every: 60

  - platform: uptime
    name: "Uptime"
    type:
      timestamp
    entity_category: diagnostic

  - platform: wifi_signal
    name: "WiFi Signal dB"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"

  - platform: copy
    source_id: wifi_signal_db
    name: "WiFi Signal Percent"
    # map input values from x=-100 to x=-50 into 0â€“100%
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "Signal %"
    entity_category: "diagnostic"
    device_class: ""